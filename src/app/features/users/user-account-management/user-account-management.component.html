<p-card [header]="'users.header' | translate">
    <div class="card">
        <!-- Filters Section -->
        <div class="action-container">
            <!-- Search -->
            <p-iconfield>
                <p-inputicon class="pi pi-search" />
                <input type="text" pInputText [placeholder]="'users.filters.searchPlaceholder' | translate"
                    [style]="{ width: '360px' }" [(ngModel)]="searchKeyword" (input)="onSearch($event)"
                    [disabled]="loading" />
            </p-iconfield>

            <!-- City Filter -->
            <p-select [options]="cities" [(ngModel)]="selectedCityId" [optionLabel]="cityOptionLabel" optionValue="id"
                [placeholder]="'users.filters.cityPlaceholder' | translate" (onChange)="onFilterChange()"
                [disabled]="loading" [showClear]="true" [filter]="true" />

            <!-- User Type Filter -->
            <p-select [options]="filterOptions" [(ngModel)]="selectedFilter" optionLabel="label" optionValue="value"
                [placeholder]="'users.filters.typePlaceholder' | translate" (onChange)="onFilterChange()"
                [disabled]="loading" [showClear]="true" />
        </div>

        <p-table [value]="users" [scrollable]="true" [paginator]="true" [rows]="rows" [first]="first"
            [totalRecords]="totalRecords" [lazy]="true" showGridlines stripedRows
            [currentPageReportTemplate]="pageReportTemplate" (onPage)="pageChange($event)"
            [rowsPerPageOptions]="[10, 25, 50]" scrollHeight="600px" [loading]="loading" [showCurrentPageReport]="true"
            paginatorPosition="bottom">

            <ng-template #header>
                <tr>
                    <th style="min-width:200px">{{'users.table.userName' | translate}}</th>
                    <th style="min-width:200px">{{'users.table.companyName' | translate}}</th>
                    <th style="min-width:150px">{{'users.table.phone' | translate}}</th>
                    <th style="min-width:200px">{{'users.table.email' | translate}}</th>
                    <th style="min-width:150px">{{'users.table.city' | translate}}</th>
                    <th style="min-width:120px">{{'users.table.joinDate' | translate}}</th>
                    <th style="min-width:120px">{{'users.table.premium' | translate}}</th>
                    <th style="min-width:120px">{{'users.table.banStatus' | translate}}</th>
                    <th style="min-width:300px">{{'users.table.actions' | translate}}</th>
                </tr>
            </ng-template>

            <ng-template #body let-user>
                <tr>
                    <td>{{user.userName}}</td>
                    <td>{{user.companyName || '-'}}</td>
                    <td>{{user.phone}}</td>
                    <td>{{user.email}}</td>
                    <td>{{user.city}}</td>
                    <td>{{user.joinDate}}</td>
                    <td>
                        @if (user.isPremium) {
                        <p-tag severity="primary" [value]="'users.tag.premium' | translate" />
                        } @else {
                        <p-tag severity="secondary" [value]="'users.tag.regular' | translate" />
                        }
                    </td>
                    <td>
                        @if (user.isBlocked) {
                        <p-tag severity="danger" [value]="'users.tag.banned' | translate" />
                        } @else {
                        <p-tag severity="success" [value]="'users.tag.active' | translate" />
                        }
                    </td>
                    <td>
                        <div class="table-actions">
                            <p-button [pTooltip]="'users.button.view' | translate" icon="pi pi-eye" [disabled]="loading"
                                (click)="showViewDialog(user)" />
                            <p-button
                                [pTooltip]="(user.isBlocked ? 'users.button.unban' : 'users.button.ban') | translate"
                                [severity]="user.isBlocked ? 'success' : 'danger'"
                                [icon]="user.isBlocked ? 'pi pi-lock-open' : 'pi pi-lock'" [disabled]="loading"
                                (click)="confirmBanToggle($event, user)" />
                            <p-button
                                [pTooltip]="(user.isPremium ? 'users.button.makeRegular' : 'users.button.makePremium') | translate"
                                [severity]="user.isPremium ? 'secondary' : 'primary'"
                                [icon]="user.isPremium ? 'pi pi-user' : 'pi pi-star'" [disabled]="loading"
                                (click)="confirmPremiumToggle($event, user)" />
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9">
                        @if (searchKeyword && searchKeyword.trim()) {
                        <div class="empty-container">
                            <i class="pi pi-search"></i>
                            <h4>{{'users.empty.search' | translate:{ keyword: searchKeyword } }}</h4>
                        </div>
                        } @else {
                        <div class="empty-container">
                            <i class="pi pi-info-circle"></i>
                            <h4>{{'users.empty.default' | translate}}</h4>
                        </div>
                        }
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-card>

<!-- View User Details Dialog -->
<p-dialog [header]="'users.dialog.title' | translate" [modal]="true" [(visible)]="viewDialogVisible"
    [style]="{ width: '45rem' }" [closable]="!loading" [draggable]="false" [resizable]="false">
    @if (selectedUser) {
    <div class="details-container">
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.userName' | translate}}:</label>
            <span class="detail-value">{{selectedUser.userName}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.companyName' | translate}}:</label>
            <span class="detail-value">{{selectedUser.companyName || '-'}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.phone' | translate}}:</label>
            <span class="detail-value">{{selectedUser.phone}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.email' | translate}}:</label>
            <span class="detail-value">{{selectedUser.email}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.profileImage' | translate}}:</label>
            <span class="detail-value">{{selectedUser.profileImage || ('users.dialog.noImage' | translate)}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.followingStatus' | translate}}:</label>
            @if (selectedUser.isFollowing) {
            <p-tag severity="success" [value]="'users.tag.following' | translate" />
            } @else {
            <p-tag severity="secondary" [value]="'users.tag.notFollowing' | translate" />
            }
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.followersCount' | translate}}:</label>
            <span class="detail-value">{{selectedUser.metaData.followersCount}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.followingCount' | translate}}:</label>
            <span class="detail-value">{{selectedUser.metaData.followingCount}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'users.dialog.fields.averageRating' | translate}}:</label>
            <span class="detail-value">{{selectedUser.metaData.averageRating}}</span>
        </div>
    </div>

    <div class="dialog-footer">
        <p-button [label]="'users.button.close' | translate" severity="secondary" (click)="closeViewDialog()" />
    </div>
    }
</p-dialog>

<p-toast />
<p-confirmpopup />