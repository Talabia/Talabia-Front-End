<p-card header="User Account Management">
    <div class="card">
        <!-- Filters Section -->
        <div class="action-container">
            <!-- Search -->
            <p-iconfield>
                <p-inputicon class="pi pi-search" />
                <input type="text" pInputText placeholder="Search users..." [(ngModel)]="searchKeyword"
                    (input)="onSearch($event)" [disabled]="loading" />
            </p-iconfield>

            <!-- City Filter -->
            <p-select [options]="cities" [(ngModel)]="selectedCityId" optionLabel="nameEn" optionValue="id"
                placeholder="Filter by City" (onChange)="onFilterChange()" [disabled]="loading" [showClear]="true" />

            <!-- User Type Filter -->
            <p-select [options]="filterOptions" [(ngModel)]="selectedFilter" optionLabel="label" optionValue="value"
                placeholder="Filter by Type" (onChange)="onFilterChange()" [disabled]="loading" [showClear]="true" />
        </div>

        <p-table [value]="users" [scrollable]="true" [paginator]="true" [rows]="rows" [first]="first"
            [totalRecords]="totalRecords" [lazy]="true" showGridlines stripedRows
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            (onPage)="pageChange($event)" [rowsPerPageOptions]="[10, 25, 50]" scrollHeight="600px" [loading]="loading"
            [showCurrentPageReport]="true" paginatorPosition="bottom">

            <ng-template #header>
                <tr>
                    <th style="min-width:200px">User Name</th>
                    <th style="min-width:200px">Company Name</th>
                    <th style="min-width:150px">Phone</th>
                    <th style="min-width:200px">Email</th>
                    <th style="min-width:150px">City</th>
                    <th style="min-width:120px">Join Date</th>
                    <th style="min-width:120px">Premium</th>
                    <th style="min-width:120px">Ban Status</th>
                    <th style="min-width:300px">Actions</th>
                </tr>
            </ng-template>

            <ng-template #body let-user>
                <tr>
                    <td>{{user.userName}}</td>
                    <td>{{user.companyName || '-'}}</td>
                    <td>{{user.phone}}</td>
                    <td>{{user.email}}</td>
                    <td>{{user.city}}</td>
                    <td>{{user.joinDate}}</td>
                    <td>
                        @if (user.isPremium) {
                        <p-tag severity="primary" value="Premium" />
                        } @else {
                        <p-tag severity="secondary" value="Regular" />
                        }
                    </td>
                    <td>
                        @if (user.isBlocked) {
                        <p-tag severity="danger" value="Banned" />
                        } @else {
                        <p-tag severity="success" value="Active" />
                        }
                    </td>
                    <td>
                        <div class="table-actions">
                            <p-button label="View" [disabled]="loading" (click)="showViewDialog(user)" />
                            <p-button [label]="user.isBlocked ? 'Unban' : 'Ban'"
                                [severity]="user.isBlocked ? 'success' : 'danger'" [disabled]="loading"
                                (click)="toggleBanStatus(user)" />
                            <p-button [label]="user.isPremium ? 'Make Regular' : 'Make Premium'"
                                [severity]="user.isPremium ? 'secondary' : 'primary'" [disabled]="loading"
                                (click)="togglePremiumStatus(user)" />
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9">
                        @if (searchKeyword && searchKeyword.trim()) {
                        <div class="empty-container">
                            <i class="pi pi-search"></i>
                            <h4>No users found matching <strong>"{{searchKeyword}}"</strong></h4>
                        </div>
                        } @else {
                        <div class="empty-container">
                            <i class="pi pi-info-circle"></i>
                            <h4>No users available</h4>
                        </div>
                        }
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-card>

<!-- View User Details Dialog -->
<p-dialog header="User Details" [modal]="true" [(visible)]="viewDialogVisible" [style]="{ width: '45rem' }"
    [closable]="!loading" [draggable]="false" [resizable]="false">
    @if (selectedUser) {
    <div class="details-container">
        <div class="detail-row">
            <label class="detail-label">User Name:</label>
            <span class="detail-value">{{selectedUser.userName}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Company Name:</label>
            <span class="detail-value">{{selectedUser.companyName || '-'}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Phone:</label>
            <span class="detail-value">{{selectedUser.phone}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Email:</label>
            <span class="detail-value">{{selectedUser.email}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Profile Image:</label>
            <span class="detail-value">{{selectedUser.profileImage || 'No image'}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Following Status:</label>
            @if (selectedUser.isFollowing) {
            <p-tag severity="success" value="Following" />
            } @else {
            <p-tag severity="secondary" value="Not Following" />
            }
        </div>
        <div class="detail-row">
            <label class="detail-label">Followers Count:</label>
            <span class="detail-value">{{selectedUser.metaData.followersCount}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Following Count:</label>
            <span class="detail-value">{{selectedUser.metaData.followingCount}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">Average Rating:</label>
            <span class="detail-value">{{selectedUser.metaData.averageRating}}</span>
        </div>
    </div>

    <div class="dialog-footer">
        <p-button label="Close" severity="secondary" (click)="closeViewDialog()" />
    </div>
    }
</p-dialog>

<p-toast />