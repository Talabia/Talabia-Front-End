<p-card [header]="'reports.header' | translate">
    <div class="card">
        <!-- Filters Section -->
        <div class="action-container">
            <!-- Date Range Filter -->
            <p-datepicker [(ngModel)]="rangeDates" selectionMode="range" [readonlyInput]="true" showIcon
                iconDisplay="input" [showClear]="true" [placeholder]="'reports.filters.datePlaceholder' | translate"
                style="min-width: 300px;" (onSelect)="onDateRangeChange($event)" (onClear)="onFilterChange()"
                [disabled]="loading" />

            <!-- Report Type Filter -->
            <p-select [options]="typeFilterOptions" [(ngModel)]="selectedReportType" optionLabel="label"
                optionValue="value" [placeholder]="'reports.filters.typePlaceholder' | translate"
                (onChange)="onFilterChange()" [disabled]="loading" [showClear]="true" />

            <!-- Status Filter -->
            <p-select [options]="statusFilterOptions" [(ngModel)]="selectedStatus" optionLabel="label"
                optionValue="value" [placeholder]="'reports.filters.statusPlaceholder' | translate"
                (onChange)="onFilterChange()" [disabled]="loading" [showClear]="true" />

            <!-- Report Reason Filter -->
            <p-select [options]="reportReasons" [(ngModel)]="selectedReportReasonId" optionLabel="name" optionValue="id"
                [placeholder]="'reports.filters.reasonPlaceholder' | translate" (onChange)="onFilterChange()"
                [disabled]="loading" [showClear]="true" />
            <!-- Bulk Actions -->
            @if (selectedReports.length > 0) {
            <p-divider layout="vertical" />
            <p-button [label]="'reports.bulk.changeStatus' | translate:{ count: selectedReports.length }"
                icon="pi pi-pencil" severity="success" (click)="showBulkStatusDialog()" [disabled]="loading" />
            }
        </div>

        <p-table [value]="reports" [(selection)]="selectedReports" [scrollable]="true" [paginator]="true" [rows]="rows"
            [first]="first" [totalRecords]="totalRecords" [lazy]="true" showGridlines stripedRows
            [currentPageReportTemplate]="'table.currentPageReport' | translate" (onPage)="pageChange($event)"
            [rowsPerPageOptions]="[10, 25, 50]" scrollHeight="600px" [loading]="loading" [showCurrentPageReport]="true"
            paginatorPosition="bottom" dataKey="id">

            <ng-template #header>
                <tr>
                    <th style="width:50px">
                        <p-checkbox [(ngModel)]="selectAll" [binary]="true" (onChange)="onSelectAllChange($event)" />
                    </th>
                    <th style="min-width:120px">{{'reports.table.type' | translate}}</th>
                    <th style="min-width:200px">{{'reports.table.reporter' | translate}}</th>
                    <th style="min-width:150px">{{'reports.table.reason' | translate}}</th>
                    <th style="min-width:250px">{{'reports.table.description' | translate}}</th>
                    <th style="min-width:120px">{{'reports.table.status' | translate}}</th>
                    <th style="min-width:120px">{{'reports.table.createdAt' | translate}}</th>
                    <th style="min-width:300px">{{'reports.table.actions' | translate}}</th>
                </tr>
            </ng-template>

            <ng-template #body let-report>
                <tr>
                    <td>
                        <p-checkbox [(ngModel)]="selectedReports" [value]="report" [binary]="false" />
                    </td>
                    <td>
                        <p-tag [value]="getTypeDisplayName(report.reportType)"
                            [severity]="getTypeSeverity(report.reportType)" />
                    </td>
                    <td>
                        <strong>{{report.reporterName}}</strong>
                        <span style="display: block; font-size: 0.875rem; color: var(--p-text-muted-color);">
                            {{report.reporterEmail}}
                        </span>
                    </td>
                    <td>{{report.reportReasonName}}</td>
                    <td>{{truncateText(report.description, 100)}}</td>
                    <td>
                        <p-tag [value]="report.status" [severity]="getStatusSeverity(report.status)" />
                    </td>
                    <td>{{report.createdAt | date:'short'}}</td>
                    <td>
                        <div class="table-actions">
                            <p-button icon="pi pi-eye" [pTooltip]="'reports.button.view' | translate" severity="primary"
                                [disabled]="loading" (click)="showViewDialog(report)" />
                            <p-button icon="pi pi-pencil" [pTooltip]="'reports.button.changeStatus' | translate"
                                severity="success" [disabled]="loading" (click)="showStatusDialog(report)" />
                            <p-button icon="pi pi-trash" [pTooltip]="'reports.button.delete' | translate"
                                severity="danger" [disabled]="loading" (click)="confirmDelete($event, report)" />
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9">
                        <div class="empty-container">
                            <i class="pi pi-inbox"></i>
                            <h4>{{'reports.empty.default' | translate}}</h4>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-card>

<!-- View Report Details Dialog -->
<p-dialog [header]="'reports.dialog.view.title' | translate" [modal]="true" [(visible)]="viewDialogVisible"
    [style]="{ width: '50rem' }" [closable]="!loading" [draggable]="false" [resizable]="false">
    @if (selectedReport) {
    <div class="details-container">
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.reportType' | translate}}:</label>

            <p-tag [value]="getTypeDisplayName(selectedReport.reportType)"
                [severity]="getTypeSeverity(selectedReport.reportType)" />
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.status' | translate}}:</label>

            <p-tag [value]="selectedReport.status" [severity]="getStatusSeverity(selectedReport.status)" />
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.reporterName' | translate}}:</label>

            <span class="detail-value">{{selectedReport.reporterName}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.reporterEmail' | translate}}:</label>

            <span class="detail-value">{{selectedReport.reporterEmail}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.reportReason' | translate}}:</label>

            <span class="detail-value">{{selectedReport.reportReasonName}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.description' | translate}}:</label>

            <div class="detail-value" style="white-space: pre-wrap; max-width: 400px;">{{selectedReport.description}}
            </div>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.createdAt' | translate}}:</label>

            <span class="detail-value">{{selectedReport.createdAt | date:'medium'}}</span>
        </div>
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.updatedAt' | translate}}:</label>

            <span class="detail-value">{{selectedReport.updatedAt | date:'medium'}}</span>
        </div>
        @if (selectedReport.adminNotes) {
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.adminNotes' | translate}}:</label>

            <div class="detail-value" style="white-space: pre-wrap; max-width: 400px;">{{selectedReport.adminNotes}}
            </div>
        </div>
        }
        @if (selectedReport.actionTaken) {
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.actionTaken' | translate}}:</label>

            <div class="detail-value" style="white-space: pre-wrap; max-width: 400px;">{{selectedReport.actionTaken}}
            </div>
        </div>
        }
        @if (selectedReport.reviewerName) {
        <div class="detail-row">
            <label class="detail-label">{{'reports.dialog.fields.reviewer' | translate}}:</label>

            <span class="detail-value">{{selectedReport.reviewerName}}</span>
        </div>
        }
    </div>

    <div class="dialog-footer">
        <p-button [label]="'reports.button.cancel' | translate" severity="secondary" (click)="closeViewDialog()" />
    </div>
    }
</p-dialog>

<!-- Status Change Dialog -->
<p-dialog [header]="'reports.dialog.status.title' | translate" [modal]="true" [(visible)]="statusDialogVisible"
    [style]="{ width: '30rem' }" [closable]="!loading" [draggable]="false" [resizable]="false">
    <form [formGroup]="statusForm" (ngSubmit)="submitStatusChange()">
        <div class="input-container">
            <label for="status" class="font-semibold w-24">{{'reports.table.status' | translate}} <span>*</span></label>
            <p-select [options]="statusFilterOptions.slice(1)" formControlName="status" optionLabel="label"
                optionValue="value" [placeholder]="'reports.filters.statusPlaceholder' | translate" [disabled]="loading"
                [invalid]="hasError('status')" />

            @if (hasError('status') || statusForm.get('status')?.dirty || statusForm.get('status')?.touched) {
            <p-message severity="error" size="small" variant="simple">
                {{getErrorMessage('status')}}
            </p-message>
            }
        </div>

        <div class="input-container">
            <label for="adminNotes" class="font-semibold w-24">{{'reports.dialog.fields.adminNotes' | translate}}
                <span>*</span></label>
            <textarea pTextarea id="adminNotes" formControlName="adminNotes" rows="3"
                [placeholder]="'reports.dialog.fields.adminNotes' | translate" [disabled]="loading"
                [invalid]="hasError('adminNotes')"></textarea>

            @if (hasError('adminNotes') || statusForm.get('adminNotes')?.dirty || statusForm.get('adminNotes')?.touched)
            {
            <p-message severity="error" size="small" variant="simple">
                {{getErrorMessage('adminNotes')}}
            </p-message>
            }
        </div>

        <div class="input-container">
            <label for="actionTaken" class="font-semibold w-24">{{'reports.dialog.fields.actionTaken' | translate}}
                <span>*</span></label>
            <textarea pTextarea id="actionTaken" formControlName="actionTaken" rows="3"
                [placeholder]="'reports.dialog.fields.actionTaken' | translate" [disabled]="loading"
                [invalid]="hasError('actionTaken')"></textarea>

            @if (hasError('actionTaken') || statusForm.get('actionTaken')?.dirty ||
            statusForm.get('actionTaken')?.touched) {
            <p-message severity="error" size="small" variant="simple">
                {{getErrorMessage('actionTaken')}}
            </p-message>
            }
        </div>

        <div class="dialog-footer">
            <p-button [label]="'reports.button.cancel' | translate" severity="secondary" type="button"
                [disabled]="loading" (click)="closeStatusDialog()" />
            <p-button [label]="'reports.button.updateStatus' | translate" type="submit" [loading]="loading"
                [disabled]="statusForm.invalid && submitted" />
        </div>
    </form>
</p-dialog>

<p-toast />
<p-confirmpopup />